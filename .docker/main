FROM python:3.8-buster as main-base

RUN apt-get update && \
    apt-get -y upgrade && \
    apt-get install -y \
    supervisor \
    nginx \
    inotify-tools \
    rsync && \
    apt autoremove -y && \
    rm -rf /var/lib/apt/lists/* 

COPY app/requirements.txt /code/requirements.txt

WORKDIR /code

RUN pip3 --no-cache-dir install -r /code/requirements.txt uwsgi && \
    chown -R www-data:www-data /code/

FROM main-base as main-backend

COPY app/ /code/

FROM main-backend as main-frontend

COPY --from=herdbook_frontend:latest --chown=www-data:www-data /app/dist/ /app/dist/
RUN cd /app/dist && ln -s . static

FROM main-frontend

COPY system/supervisord.conf /etc/
COPY system/nginx.conf /etc/nginx/
COPY system/herdbook.devel.nginx /etc/nginx/herdbook.devel
COPY system/herdbook.standalone.nginx /etc/nginx/herdbook.standalone

COPY system/entrypoint.sh /

CMD /entrypoint.sh
