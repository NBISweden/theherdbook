FROM rocker/r-ver:4.0.2 as R-build

RUN apt update \
  && apt install -y --no-install-recommends \
  libpq-dev \
  libglu1-mesa-dev \
  libpng-dev \
  libgl1-mesa-dev \
  zlib1g-dev \
  make \
  libicu-dev \
  libfreetype6-dev \
  libmagick++-dev \
  libcurl4-openssl-dev \
  libssl-dev \
  libxml2-dev \
  pkg-config \
  libsodium-dev \
  libicu-dev \
  && apt autoremove -y \
  && rm -rf /var/lib/apt/lists/*

RUN MAKEFLAGS='-j4' Rscript -e 'install.packages(c("RPostgres","optiSel","plumber","jsonlite","nprcgenekeepr"),repos=c("https://packagemanager.rstudio.com/all/__linux__/focal/345","https://ftp.acc.umu.se/mirror/CRAN/","https://cloud.r-project.org/"),clean=TRUE, Ncpus=8);'

FROM rocker/r-ver:4.0.2

COPY --from=R-build /usr/local/lib/R/site-library /usr/local/lib/R/site-library

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
  libglu1-mesa \
  pandoc \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/local/r-api

COPY R .

ENTRYPOINT ["Rscript", "/usr/local/r-api/serve.R"]
